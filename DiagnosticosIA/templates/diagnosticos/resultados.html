{% extends 'Dentista/base.html' %}
{% block content %}

<div class="container py-4">
    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 fw-bold text-primary mb-1">
                <i class="bi bi-card-image me-2"></i>Resultados de Detección
            </h1>
            <p class="text-muted">Análisis de imagen odontológica procesada</p>
        </div>
        <a href="{% url 'diagnosticos' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i> Volver
        </a>
    </div>

    <!-- Información del paciente -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-0 py-3">
            <h3 class="h5 mb-0">
                <i class="bi bi-person-badge me-2"></i> Información del Paciente
            </h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label text-muted small mb-1">Paciente</label>
                        <p class="mb-0 fw-semibold">{{ imagen.paciente.nombre }} {{ imagen.paciente.appat }}</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label text-muted small mb-1">Fecha de Consulta</label>
                        <p class="mb-0">{{ imagen.consulta.fecha_consulta|date:"d/m/Y" }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Visualización de imágenes -->
    <div class="row">
        <!-- Imagen original -->
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center py-3">
                    <h3 class="h5 mb-0">
                        <i class="bi bi-image me-2"></i> Imagen Original
                    </h3>
                    <span class="badge bg-primary rounded-pill">Original</span>
                </div>
                <div class="card-body">
                    <div id="openseadragon-original" style="width: 100%; height: 400px; border: 1px solid #dee2e6; border-radius: 0.375rem;"></div>
                </div>
            </div>
        </div>

        <!-- Imagen procesada -->
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center py-3">
                    <h3 class="h5 mb-0">
                        <i class="bi bi-gear-fill me-2"></i> Imagen Procesada
                    </h3>
                    {% if imagen.resultados %}
                    <span class="badge bg-success rounded-pill">Procesada</span>
                    {% else %}
                    <span class="badge bg-warning rounded-pill">Pendiente</span>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if imagen.resultados %}
                    <div id="openseadragon-procesada" style="width: 100%; height: 400px; border: 1px solid #dee2e6; border-radius: 0.375rem;"></div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-hourglass-top display-4 text-muted mb-3"></i>
                        <h5 class="text-muted">Imagen no procesada</h5>
                        <p class="text-muted small">Esta imagen aún no ha sido procesada por el sistema.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Acciones -->
    {% if imagen.resultados %}
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0 py-3">
            <h3 class="h5 mb-0">
                <i class="bi bi-tools me-2"></i> Acciones
            </h3>
        </div>
        <div class="card-body">
            <div class="d-flex gap-2">
                <a href="{{ imagen.resultados.url }}" class="btn btn-outline-primary" download>
                    <i class="bi bi-download me-1"></i> Descargar Resultados
                </a>
                <a href="#" class="btn btn-outline-success">
                    <i class="bi bi-printer me-1"></i> Imprimir Reporte
                </a>
                <a href="#" class="btn btn-outline-info">
                    <i class="bi bi-graph-up me-1"></i> Ver Métricas
                </a>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Librería OpenSeadragon -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/openseadragon.min.js"></script>

<script>
    // Viewer para la imagen original
    var viewerOriginal = OpenSeadragon({
        id: "openseadragon-original",
        prefixUrl: "https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/images/",
        tileSources: {
            type: 'image',
            url: "{{ imagen.imagen.url }}"
        },
        showNavigator: true,
        defaultZoomLevel: 0,
        minZoomLevel: 0.5,
        maxZoomLevel: 20,
        showRotationControl: true,
        showHomeControl: true,
        showFullPageControl: true
    });

    // Viewer para la imagen procesada (solo si existe)
    {% if imagen.resultados %}
    var viewerProcesada = OpenSeadragon({
        id: "openseadragon-procesada",
        prefixUrl: "https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/images/",
        tileSources: {
            type: 'image',
            url: "{{ imagen.resultados.url }}"
        },
        showNavigator: true,
        defaultZoomLevel: 0,
        minZoomLevel: 0.5,
        maxZoomLevel: 20,
        showRotationControl: true,
        showHomeControl: true,
        showFullPageControl: true
    });
    {% endif %}
</script>

<style>
    .card {
        border-radius: 0.5rem;
    }
    
    .openseadragon {
        border-radius: 0.375rem;
    }
    
    .btn {
        border-radius: 0.375rem;
    }
</style>

{% endblock %}